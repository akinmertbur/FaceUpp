<%- include('partials/header') %>
<div>
  <a href="/">Home</a>
  <% if (locals.user) { %>
    <div class="first-section">
      <div class="photo-gallery">
        <div class="photo-item">
          <% if (locals.profilePicture) { %>
            <img id="profile-picture" src="<%= profilePicture %>" alt="Profile Picture">
          <% } else { %>
            <img id="profile-picture" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" alt="Profile Picture">
          <% } %>
        </div>
      </div>

      <div class="username-bio">
        <h1><%= user.username %></h1>
        <div class="bio">
          <p><%= user.bio %></p>
        </div>
      </div>
      <div class="followings-followers">
        <button id="followings-button" class="btn btn-dark" onclick="toggleFollowingsPanel()" ><%= followings.length %> Followings</button>
        <button id="followers-button" class="btn btn-dark" onclick="toggleFollowersPanel()" ><%= followers.length %> Followers</button>
      </div>
      <div class="followings-followers-container">
        <div id="followings-container" class="followings-list hide">
          <p>Followings</p>
          <% if (followings.length > 0) { %>
            <ul>
              <% followings.forEach(user => { %>
                <li><a href="/userProfile/<%= user.id %>"><%= user.username %></a></li>
              <% }) %>
            </ul>
          <% } %>
        </div>
        <div id="followers-container" class="followers-list hide">
          <p>Followers</p>
          <% if (followers.length > 0) { %>
            <ul>
              <% followers.forEach(user => { %>
                <li><a href="/userProfile/<%= user.id %>"><%= user.username %></a></li>
              <% }) %>
            </ul>
          <% } %>
        </div>
      </div>
    </div>
    
  <% } %>
</div>
<div class="second-section">
  <button id="editBioButton" class="btn btn-dark" onclick="toggleHideBio()">Edit Bio</button>
  <button id="editUsernameButton" class="btn btn-dark" onclick="toggleHideUsername()">Edit Username</button>
  <button id="editEmailButton" class="btn btn-dark" onclick="toggleHideEmail()">Edit Email</button>
  <button id="editPasswordButton" class="btn btn-dark" onclick="toggleHidePassword()">Edit Password</button>
  <button id="addProfilePictureButton" class="btn btn-dark" onclick="toggleHideProfilePicture()">Add Profile Picture</button>
</div>

<form action="/api/users/editBio" method="POST" onsubmit="return validateBioForm()">
  <div class="form-group">
    <input type="hidden" class="form-control hide" name="userId" value="<%= user.id %>">
    <input id="editBioInputField" type="text" class="form-control hide" name="bioText" required>
  </div>
  <button id="saveBioButton" type="submit" class="btn btn-dark hide">Save</button>
</form>

<form action="/api/users/editUsername" method="POST" onsubmit="return validateUsernameForm()">
  <div class="form-group">
    <input type="hidden" class="form-control hide" name="userId" value="<%= user.id %>">
    <input id="editUsernameInputField" type="text" class="form-control hide" name="username" required>
  </div>
  <button id="saveUsernameButton" type="submit" class="btn btn-dark hide">Save</button>
</form>

<form action="/api/users/editEmail" method="POST" onsubmit="return validateEmailForm()">
  <div class="form-group">
    <input type="hidden" class="form-control hide" name="userId" value="<%= user.id %>">
    <input id="editEmailInputField" type="email" class="form-control hide" name="email" required>
  </div>
  <button id="saveEmailButton" type="submit" class="btn btn-dark hide">Save</button>
</form>

<form action="/api/auth/editPassword" method="POST" onsubmit="return validatePasswordForm()">
  <div class="form-group">
    <input id="editPasswordInputField" type="password" class="form-control hide" name="password" required>
  </div>
  <button id="savePasswordButton" type="submit" class="btn btn-dark hide">Save</button>
</form>

<form action="/api/users/editProfilePicture" method="POST" enctype="multipart/form-data" onsubmit="return validateAddProfilePictureForm()">
  <div class="form-group">
    <input type="hidden" class="form-control hide" name="userId" value="<%= user.id %>">
    <input type="file" class="form-control hide" id="photo" name="photo" accept="image/*">
    <div class="invalid-feedback" id="photoError"></div>
  </div>
  <button id="saveProfilePictureButton" type="submit" class="btn btn-dark hide">Save</button>
</form>

<% if (likesByPhoto && photos_info && photos && photos.length > 0) { %>
  <div class="photo-gallery">
    <% for(let i = 0; i<photos.length; i++) { %>
      <div class="photo-container">
        <div class="photo-item">
          <img src="<%= photos[i].localUrl %>" alt="Photo">
        </div>
        <div class="photo-bio">
          <p><%= photos_info[i].caption  %></p>
        </div>
        <div>
          <button id="likes-count<%= i %>" class="btn btn-dark" onclick="toggleLikesPanel('<%= i %>')"><%= likesByPhoto[i].length %> Likes</button>
        </div>
        <div class="photo-buttons">
          <% if(locals.likeDetails[i]) { %>
            <form action="/api/likes/unlike" method="POST">
              <div class="form-group">
                <input hidden type="text" class="form-control" name="userId" value="<%= user.id %>">
                <input hidden type="text" class="form-control" name="photoId" value="<%= photos_info[i].id %>">
              </div>
              <button type="submit" class="btn btn-dark">Unlike</button>
            </form>
          <% } else { %>
            <form action="/api/likes/like" method="POST">
              <div class="form-group">
                <input hidden type="text" class="form-control" name="userId" value="<%= user.id %>">
                <input hidden type="text" class="form-control" name="photoId" value="<%= photos_info[i].id %>">
              </div>
              <button type="submit" class="btn btn-dark">Like</button>
            </form>
          <% } %>
          <button class="btn btn-dark">Add Comment</button>
        </div>
        <div id="likes-panel<%= i %>" class="hide">
          <% likesByPhoto[i].map(x => { %>
            <p><%= x %></p>       
          <% }); %>  
        </div>
      </div>
    <% } %>
  </div>
<% } else { %>
  <p>No photos available.</p>
<% } %>

<script>
  function toggleHideBio() {
    const editBioInputField = document.getElementById('editBioInputField');
    const saveBioButton = document.getElementById('saveBioButton');
    const editBioButton = document.getElementById('editBioButton');

    if (editBioInputField.classList.contains('hide')) {
      editBioInputField.classList.remove('hide');
      saveBioButton.classList.remove('hide');
      editBioButton.classList.add('hide');
    } else {
      editBioInputField.classList.add('hide');
      saveBioButton.classList.add('hide');
      editBioButton.classList.remove('hide');
    }
  }
  
  function toggleHideUsername() {
    const editUsernameInputField = document.getElementById('editUsernameInputField');
    const saveUsernameButton = document.getElementById('saveUsernameButton');
    const editUsernameButton = document.getElementById('editUsernameButton');

    if (editUsernameInputField.classList.contains('hide')) {
      editUsernameInputField.classList.remove('hide');
      saveUsernameButton.classList.remove('hide');
      editUsernameButton.classList.add('hide');
    } else {
      editUsernameInputField.classList.add('hide');
      saveUsernameButton.classList.add('hide');
      editUsernameButton.classList.remove('hide');
    }
  }
  
  function toggleHideEmail() {
    const editEmailInputField = document.getElementById('editEmailInputField');
    const saveEmailButton = document.getElementById('saveEmailButton');
    const editEmailButton = document.getElementById('editEmailButton');

    if (editEmailInputField.classList.contains('hide')) {
      editEmailInputField.classList.remove('hide');
      saveEmailButton.classList.remove('hide');
      editEmailButton.classList.add('hide');
    } else {
      editEmailInputField.classList.add('hide');
      saveEmailButton.classList.add('hide');
      editEmailButton.classList.remove('hide');
    }
  }
  
  function toggleHidePassword() {
    const editPasswordInputField = document.getElementById('editPasswordInputField');
    const savePasswordButton = document.getElementById('savePasswordButton');
    const editPasswordButton = document.getElementById('editPasswordButton');

    if (editPasswordInputField.classList.contains('hide')) {
      editPasswordInputField.classList.remove('hide');
      savePasswordButton.classList.remove('hide');
      editPasswordButton.classList.add('hide');
    } else {
      editPasswordInputField.classList.add('hide');
      savePasswordButton.classList.add('hide');
      editPasswordButton.classList.remove('hide');
    }
  }

  function toggleHideProfilePicture() {
    const addProfilePictureButton = document.getElementById('addProfilePictureButton');
    const saveProfilePictureButton = document.getElementById('saveProfilePictureButton');
    const photo = document.getElementById('photo');

    if (photo.classList.contains('hide')) {
      photo.classList.remove('hide');
      saveProfilePictureButton.classList.remove('hide');
      addProfilePictureButton.classList.add('hide');
    } else {
      photo.classList.add('hide');
      saveProfilePictureButton.classList.add('hide');
      addProfilePictureButton.classList.remove('hide');
    }
  }

  function toggleFollowingsPanel() {
    const followingContainer = document.getElementById("followings-container");

    if(followingContainer.classList.contains('hide')) {
      followingContainer.classList.remove('hide');
    } else {
      followingContainer.classList.add('hide');
    }
  }

  function toggleFollowersPanel() {
    const followerContainer = document.getElementById("followers-container");

    if(followerContainer.classList.contains('hide')) {
      followerContainer.classList.remove('hide');
    } else {
      followerContainer.classList.add('hide');
    }
  }

  function toggleLikesPanel(i) {
    const likesPanel = document.getElementById(`likes-panel${i}`);

    if(likesPanel.classList.contains('hide')) {
      likesPanel.classList.remove('hide');
    } else {
      likesPanel.classList.add('hide');
    }
  }

  function validateBioForm() {
    const bioText = document.getElementById('editBioInputField').value;
    if (bioText.trim() === '') {
      alert('Bio cannot be empty');
      return false;
    }
    return true;
  }

  function validateUsernameForm() {
    const username = document.getElementById('editUsernameInputField').value;
    if (username.trim() === '') {
      alert('Username cannot be empty');
      return false;
    }
    return true;
  }

  function validateEmailForm() {
    const email = document.getElementById('editEmailInputField').value;
    if (email.trim() === '') {
      alert('Email cannot be empty');
      return false;
    }
    if (!validateEmail(email)) {
      alert('Invalid email format');
      return false;
    }
    return true;
  }

  function validatePasswordForm() {
    const password = document.getElementById('editPasswordInputField').value;
    if (password.trim() === '') {
      alert('Password cannot be empty');
      return false;
    }
    if (password.length < 8) {
      alert('Password must be at least 8 characters long');
      return false;
    }
    return true;
  }

  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(String(email).toLowerCase());
  }

  function validateAddProfilePictureForm() {
    let isValid = true;

    const photo = document.getElementById('photo').files[0];

    // Photo validation
    if (!photo) {
      document.getElementById('photoError').innerText = "Photo is required";
      document.getElementById('photo').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('photoError').innerText = "";
      document.getElementById('photo').classList.remove('is-invalid');
    }
    return isValid;
  }
</script>
<%- include('partials/footer') %>
